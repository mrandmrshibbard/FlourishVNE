# Implementation Plan: Runtime Logic Stabilization

**Branch**: `001-fix-runtime-logic` | **Date**: 2025-11-04 | **Spec**: [Specification](./spec.md)
**Input**: Feature specification from `/specs/001-fix-runtime-logic/spec.md`

## Summary

Stabilize the existing runtime that powers both the editor (`LivePreview.tsx`) and exported builds (`public/game-engine.js`) so creators see deterministic command execution, consistent branching, and reliable scene cleanup. We will refactor and harden the current scheduler, variable handling, and lifecycle logic in-place, sharing improvements across the editor and bundled runtime without introducing a parallel implementation. All validation flows will lean on user-facing sample scenes (e.g., the character customization demo) so every fix remains reproducible inside the visual editor.

## Technical Context

**Language/Version**: TypeScript 5.8, React 19.2, Electron 28.x shell for desktop exports  
**Primary Dependencies**: React runtime, internal command handler modules (`src/components/live-preview/command-handlers`), existing runtime bridge inside `src/components/LivePreview.tsx`, Vite build toolchain  
**Storage**: Local JSON project files and in-memory variable stores (no remote persistence)  
**Testing**: Manual regression checklist per Constitution plus targeted runtime harness (to be added) covering branching parity and cleanup flows  
**Target Platform**: Browser-based editor with Electron packager; exported standalone HTML builds  
**Project Type**: Single-page web editor + bundled standalone engine  
**Performance Goals**: Maintain 60 FPS during command playback; zero missed/duplicated commands across 10-scene stress runs  
**Constraints**: Offline-capable exports, deterministic branching across environments, <1s scene reset budget  
**Scale/Scope**: Projects up to 100 scenes, 200 variables, and 50 simultaneous UI overlays; multiple rapid restarts in QA

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- **Principle I – Feature Completeness & Reliability**: PASS. Scheduler + lifecycle manager directly address skipped/duplicated commands and lingering state.
- **Principle IV – State Management Discipline**: PASS. Plan eliminates stale closures by centralizing state mutations in a reducer-backed runtime store.
- **Principle VI – Export & Standalone Integrity**: PASS. Refactoring the existing runtime keeps editor, test play, and exported builds on the same logic.
- **Principle VIII – Must Use Existing Setup**: PASS. Plan modifies the established runtime pipeline (LivePreview, generated game-engine bundle, existing scripts) without adding new dependencies or alternative frameworks.
- **Quality Standards – Testing Discipline**: PASS. Plan adds deterministic harnesses instead of weakening checks, aligning with updated rule.
- **Post-Phase-1 Review**: PASS. Design artifacts introduce no new constitutional risks; shared runtime keeps parity obligations intact.

## Project Structure

### Documentation (this feature)

```text
specs/001-fix-runtime-logic/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md              # generated by /speckit.tasks (future phase)
```

### Source Code (repository root)

```text
src/
├── App.tsx
├── components/
│   ├── LivePreview.tsx              # Runtime entry point for editor preview
│   ├── live-preview/
│   │   ├── command-handlers/        # Existing command handlers to be hardened
│   │   ├── runtime/                 # NEW subfolder: shared scheduler + lifecycle extracted from LivePreview
│   │   └── systems/
├── contexts/
│   └── ProjectContext.tsx
├── state/
│   ├── actions.ts
│   └── rootReducer.ts
└── utils/
    ├── commandFactory.ts
    ├── gameEngineBundle.ts          # Bridges runtime into exported bundle
    └── variableInterpolation.ts

public/
├── game-engine.js                   # Generated runtime for exported HTML
└── Sprites/

dist-standalone/
└── game-engine.js

scripts/
└── generate-engine-bundle.js        # Existing script that copies runtime into bundle
```

**Structure Decision**: Work within the established runtime hotspots—`LivePreview.tsx`, `live-preview/command-handlers`, generated `public/game-engine.js`, and the bundler script—to extract reusable scheduler and lifecycle helpers under `src/components/live-preview/runtime/` so editor and exports share code without replacing the current architecture.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
