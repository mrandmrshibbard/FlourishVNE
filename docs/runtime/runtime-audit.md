# Runtime Audit – Runtime Logic Stabilization

This document captures the current runtime touch points that power editor preview, test play, and exported builds. It will serve as the reference while we refactor logic in place.

## Editor Preview Runtime

- **Entry Point**: `src/components/LivePreview.tsx`
  - Hosts the command execution loop via `useEffect` tied to `playerState`.
  - Maintains refs such as `lastProcessedCommandRef`, `activeEffectTimeoutsRef`, `activeFlashRef`, and `activeShakeRef` to track execution and visual effects.
  - Orchestrates command handlers imported from `src/components/live-preview/command-handlers` and manages state updates, scene transitions, and cleanup.
- **Command Handlers**: `src/components/live-preview/command-handlers/`
  - Provide individual command implementations (dialogue, background changes, audio, variables, etc.).
  - Currently rely on the ambient React state owned by `LivePreview.tsx` and expect to be refactored to accept explicit context helpers.

## Exported Runtime

- **Bundled Output**: `public/game-engine.js` (mirrored in `dist-standalone/game-engine.js`)
  - Generated by `scripts/generate-engine-bundle.js` from the same React source used in the editor.
  - Contains an inlined copy of the command loop and handlers from `LivePreview.tsx` after Vite bundling.
  - Must remain in sync with editor behavior—recent bugs show race conditions stemming from duplicated logic.
- **Bundler Script**: `scripts/generate-engine-bundle.js`
  - Runs `vite build --config vite.config.standalone.ts` and writes bundled assets into `public/`.
  - Also copies supporting assets (sprites, logs) to exported targets.

## Shared Data & Samples

- **Project Sample**: `character-customization-sample.json`
  - Canonical editor-accessible project for regression scenarios (branching choices, variable updates, scene transitions).
  - Will be mirrored into `tests/runtime/fixtures/` for the deterministic harnesses defined in the task plan.

## Immediate Pain Points (from inspection)

1. **Command Execution Effect**: The effect in `LivePreview.tsx` both executes commands and mutates React state, causing race conditions when asynchronous handlers resolve.
2. **Variable Propagation**: Variable writes happen via `setPlayerState` but can be read by conditionals before React flushes the update.
3. **Scene Cleanup**: Timers, audio, and overlays rely on manual resets scattered throughout the effect; missing one leaves leaked state between scenes.
4. **Export Parity**: `public/game-engine.js` must reflect any scheduler or lifecycle adjustments made in the editor to avoid divergence.

## Next Steps

- Extract reusable helpers under `src/components/live-preview/runtime/` to isolate scheduler, variable store, diagnostics, and lifecycle management while keeping existing entry points intact.
- Build regression harnesses (see `tests/runtime/`) that load the sample project data and assert deterministic behavior across the editor and generated bundle.
